#!/bin/bash
set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è FPMI RAG Bot...${NC}"

# --- –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ .env ---
echo -e "\n${YELLOW}1/6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
if [ ! -f .env ]; then
    echo -e "${RED}–û–®–ò–ë–ö–ê: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω.${NC}"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env –Ω–∞ –æ—Å–Ω–æ–≤–µ .env.example –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ."
    exit 1
fi
echo -e "      ${GREEN}‚úì –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω.${NC}"

# --- –®–∞–≥ 2: Docker Compose ---
echo -e "\n${YELLOW}2/6. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
docker-compose up -d --build

echo -e "      ${GREEN}‚úì –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã. –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ (10 —Å–µ–∫)...${NC}"
sleep 10

# --- –®–∞–≥ 3: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ Ollama ---
echo -e "\n${YELLOW}3/6. –ó–∞–≥—Ä—É–∑–∫–∞ LLM –º–æ–¥–µ–ª–∏ (llama3.1) –≤–Ω—É—Ç—Ä—å Docker...${NC}"
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞..."
docker-compose exec ollama ollama pull llama3.1
echo -e "      ${GREEN}‚úì –ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.${NC}"

# --- –®–∞–≥ 4: –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î ---
echo -e "\n${YELLOW}4/6. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
# –°–æ–∑–¥–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç) –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º
docker-compose exec rag-cli alembic revision --autogenerate -m "Auto migration" 2>/dev/null || true
docker-compose exec rag-cli alembic upgrade head
echo -e "      ${GREEN}‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞.${NC}"

# --- –®–∞–≥ 5: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö ---
echo -e "\n${YELLOW}5/6. –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (RAG)...${NC}"
echo "–ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–±—ã—Å—Ç—Ä–æ)..."
docker-compose exec rag-cli python main.py index test
echo -e "      ${GREEN}‚úì –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–µ–∫—Ç–æ—Ä–Ω–∞—è –±–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞.${NC}"

# --- –®–∞–≥ 6: –§–∏–Ω–∞–ª ---
echo -e "\n${YELLOW}6/6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo -e "${GREEN}–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.${NC}"
echo "------------------------------------------------------------------"
echo "–í–ê–ñ–ù–û: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram –Ω—É–∂–µ–Ω HTTPS —Ç—É–Ω–Ω–µ–ª—å."
echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Node.js."
echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ –ù–û–í–û–ï –æ–∫–Ω–æ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo -e "${YELLOW}   npx localtunnel --port 8080 --subdomain famcsanswerbot${NC}"
echo "3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É (https://....loca.lt) –≤ –≤–∞—à .env —Ñ–∞–π–ª"
echo "   –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é TGSERVER__WEBHOOK_URL (–Ω–µ –∑–∞–±—É–¥—å—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å /webhook –≤ –∫–æ–Ω—Ü–µ!)."
echo "4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π: docker-compose restart bot"
echo "------------------------------------------------------------------"